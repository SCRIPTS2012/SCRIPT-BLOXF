local DataStoreService = game:GetService("DataStoreService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

-- Tạo DataStore cho ban vĩnh viễn
local BanStore = DataStoreService:GetDataStore("AdvancedBanList")
local RemoteCheck = Instance.new("RemoteEvent")
RemoteCheck.Name = "AntiCheatRemote"
RemoteCheck.Parent = ReplicatedStorage

-- Hàm obfuscate đơn giản
local function obfuscate(func)
    local wrapped = loadstring(string.dump(func))
    return wrapped
end

-- Danh sách từ toxic, phá bĩnh, và phân biệt chủng tộc
local ToxicWords = {"hack", "toxic", "bad", "cheat", "die", "kill", "f***", "s***", "pbvm", "pbct"}
local RacistWords = {"n****", "ch*nk", "g**k", "k**e", "s***m", "racist", "hate"}
local ProtectedParts = Workspace:GetDescendants() -- Vật thể cần bảo vệ

-- Hàm log ban
local function logBan(player, reason)
    print("Người chơi " .. player.Name .. " (UserId: " .. player.UserId .. ") bị ban vĩnh viễn vì: " .. reason)
end

-- Hàm kiểm tra và ban
local function advancedCheck(player)
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid")
    local rootPart = character:WaitForChild("HumanoidRootPart")
    local lastPosition = rootPart.Position
    local lastCheckTime = tick()
    local remoteCount = 0
    local isBanned = BanStore:GetAsync(player.UserId) or false
    
    if isBanned then
        player:Kick("Bạn đã bị ban vĩnh viễn do vi phạm!")
        return
    end
    
    -- Kiểm tra remote event bất thường
    RemoteCheck.OnServerEvent:Connect(function(plr, data)
        if plr == player then
            remoteCount = remoteCount + 1
            if remoteCount > 10 then
                BanStore:SetAsync(player.UserId, true)
                logBan(player, "Remote Event Spam")
                player:Kick("Phát hiện cheat: Remote Event Spam!")
            end
        end
    end)
    
    -- Kiểm tra chat toxic, phá bĩnh, và phân biệt chủng tộc
    player.Chatted:Connect(function(msg)
        msg = string.lower(msg)
        local isVietnamese = string.find(msg, "việt nam") or string.find(msg, "vn") or string.match(msg, "[áàạảãâấầậẩẫăắằặẳẵóòọỏõôốồộổỗơớờợởỡéèẹẻẽêếềệểễúùụủũưứừựửữíìịỉĩýỳỵỷỹđ]")
        local isForeign = string.match(msg, "[a-zA-Z]+") and not isVietnamese
        
        for _, word in pairs(ToxicWords) do
            if string.find(msg, word) then
                BanStore:SetAsync(player.UserId, true)
                logBan(player, "Ngôn ngữ toxic hoặc phá bĩnh chat")
                player:Kick("Bạn đã bị ban vĩnh viễn do ngôn ngữ toxic hoặc phá bĩnh chat!")
                return
            end
        end
        
        for _, word in pairs(RacistWords) do
            if string.find(msg, word) then
                BanStore:SetAsync(player.UserId, true)
                logBan(player, "Ngôn ngữ phân biệt chủng tộc")
                player:Kick("Bạn đã bị ban vĩnh viễn do ngôn ngữ phân biệt chủng tộc!")
                return
            end
        end
        
        if isForeign and (string.find(msg, "vietnamese") or string.find(msg, "vn") or string.find(msg, "asia")) then
            BanStore:SetAsync(player.UserId, true)
            logBan(player, "Ngôn ngữ phân biệt vùng miền")
            player:Kick("Phát hiện ngôn ngữ phân biệt vùng miền - Bạn đã bị ban vĩnh viễn!")
            return
        end
    end)
    
    -- Kiểm tra phá bĩnh map
    spawn(obfuscate(function()
        while wait(0.1) do
            local currentTime = tick()
            local currentPosition = rootPart.Position
            
            local distance = (currentPosition - lastPosition).Magnitude
            local timeDelta = currentTime - lastCheckTime
            local speed = distance / timeDelta
            if speed > 35 or speed < -35 then
                BanStore:SetAsync(player.UserId, true)
                logBan(player, "Speed Hack/Teleport - Phá bĩnh map")
                player:Kick("Bạn đã bị ban vĩnh viễn do Speed Hack/Teleport - Phá bĩnh map!")
                break
            end
            
            local ray = Ray.new(rootPart.Position, Vector3.new(0, -10, 0))
            local hit = workspace:FindPartOnRay(ray, character)
            if not hit or currentPosition.Y > rootPart.Position.Y + 15 or humanoid.JumpPower > 60 then
                BanStore:SetAsync(player.UserId, true)
                logBan(player, "Fly Hack - Phá bĩnh map")
                player:Kick("Bạn đã bị ban vĩnh viễn do Fly Hack - Phá bĩnh map!")
                break
            end
            
            if currentPosition.Y < -10 or not workspace:FindPartOnRay(ray) then
                BanStore:SetAsync(player.UserId, true)
                logBan(player, "Noclip - Phá bĩnh map")
                player:Kick("Bạn đã bị ban vĩnh viễn do Noclip - Phá bĩnh map!")
                break
            end
            
            for _, part in pairs(ProtectedParts) do
                if part:IsA("BasePart") and part.Anchored == false and (part.Position - rootPart.Position).Magnitude < 5 then
                    BanStore:SetAsync(player.UserId, true)
                    logBan(player, "Phá hủy hoặc di chuyển vật thể - Phá bĩnh map")
                    player:Kick("Bạn đã bị ban vĩnh viễn do phá hủy hoặc di chuyển vật thể - Phá bĩnh map!")
                    break
                end
            end
            
            local clones = 0
            for _, plr in pairs(Players:GetPlayers()) do
                if plr ~= player and plr.Character and (plr.Character.HumanoidRootPart.Position - rootPart.Position).Magnitude < 5 then
                    clones = clones + 1
                end
            end
            if clones > 1 then
                BanStore:SetAsync(player.UserId, true)
                logBan(player, "Clone Hack - Phá bĩnh map")
                player:Kick("Phát hiện cheat: Clone Hack - Phá bĩnh map!")
                break
            end
            
            lastPosition = currentPosition
            lastCheckTime = currentTime
        end
    end))
end

-- Khởi động kiểm tra khi người chơi join
Players.PlayerAdded:Connect(function(player)
    local success, err = pcall(function()
        advancedCheck(player)
    end)
    if not success then
        warn("Lỗi khi kiểm tra " .. player.Name .. ": " .. err)
    end
end)

-- Lưu ban khi server đóng
game:BindToClose(function()
    for _, player in pairs(Players:GetPlayers()) do
        if BanStore:GetAsync(player.UserId) then
            BanStore:SetAsync(player.UserId, true)
        end
    end
end)
