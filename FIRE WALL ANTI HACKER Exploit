local DataStoreService = game:GetService("DataStoreService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")
local StarterGui = game:GetService("StarterGui")

-- Tạo DataStore cho ban vĩnh viễn
local BanStore = DataStoreService:GetDataStore("PremiumAntiCheatBanList")
local RemoteCheck = Instance.new("RemoteEvent")
RemoteCheck.Name = "AntiCheatRemote"
RemoteCheck.Parent = ReplicatedStorage

-- Hàm obfuscate đơn giản
local function obfuscate(func)
    local wrapped = loadstring(string.dump(func))
    return wrapped
end

-- Danh sách từ toxic, phá map, phân biệt chủng tộc, và dấu hiệu exploit/hack
local ToxicWords = {"hack", "toxic", "bad", "cheat", "die", "kill", "f***", "s***", "pmap"}
local RacistWords = {"n****", "ch*nk", "g**k", "k**e", "s***m", "racist", "hate"}
local ExploitSigns = {"[syn]", "[krnl]", "[exploit]", "inject", "bypass", "hook", "scriptware", "fluxus", "execute", "debug", "custom", "exclusive", "modded", "customscript"}
local ProtectedParts = Workspace:GetDescendants() -- Vật thể cần bảo vệ (base, map)

-- Hàm log ban
local function logBan(player, reason)
    print("Báo cáo Premium: " .. player.Name .. " (UserId: " .. player.UserId .. ") bị ban vĩnh viễn vì: " .. reason)
end

-- Hàm phát cảnh báo toàn server
local function broadcastWarning(bannedPlayer, reason)
    local warningMessage = "CẢNH BÁO PREMIUM: Người chơi " .. bannedPlayer.Name .. " bị ban vĩnh viễn do " .. reason .. "!\nBẤT KỲ AI TIẾP TỤC HACK SẼ BỊ BAN NGAY LẬP TỨC!"
    StarterGui:SetCore("ChatMakeSystemMessage", {
        Text = warningMessage,
        Color = Color3.fromRGB(255, 0, 0),
        Font = Enum.Font.SourceSansBold
    })
end

-- Hàm xử lý ban tức thì
local function banImmediately(player, reason)
    local success, err = pcall(function()
        BanStore:SetAsync(player.UserId, true)
        logBan(player, reason)
        broadcastWarning(player, reason)
        player:Kick("Bạn đã bị ban vĩnh viễn do: " .. reason)
    end)
    if not success then
        warn("Lỗi khi ban Premium " .. player.Name .. ": " .. err)
    end
end

-- Hàm kiểm tra và ban nâng cấp với phát hiện hack nâng cao
local function advancedCheck(player)
    local character = player.Character or player.CharacterAdded:Wait()
    local humanoid = character:WaitForChild("Humanoid")
    local rootPart = character:WaitForChild("HumanoidRootPart")
    local lastPosition = rootPart.Position
    local lastCheckTime = tick()
    local remoteCount = 0
    local exploitSuspicion = 0
    local lastRemoteTime = tick()
    local lastVelocity = rootPart.Velocity
    local customDataCheck = {} -- Theo dõi dữ liệu tùy chỉnh
    local customObjectCheck = {} -- Theo dõi vật thể tùy chỉnh
    local isBanned = BanStore:GetAsync(player.UserId) or false
    
    if isBanned then
        player:Kick("Bạn đã bị ban vĩnh viễn do vi phạm!")
        return
    end
    
    -- Điều chỉnh tần suất kiểm tra dựa trên số lượng người chơi
    local checkInterval = math.clamp(1 / (#Players:GetPlayers() / 10), 0.05, 0.5)
    
    -- Kiểm tra remote event (phát hiện exploit/hack tùy chỉnh)
    RemoteCheck.OnServerEvent:Connect(function(plr, data)
        if plr == player then
            local currentTime = tick()
            remoteCount = remoteCount + 1
            exploitSuspicion = exploitSuspicion + 1
            local timeDelta = currentTime - lastRemoteTime
            if timeDelta < 0.05 or remoteCount > math.clamp(10 + (#Players:GetPlayers() * 0.5), 10, 20) then
                exploitSuspicion = exploitSuspicion + 3
            end
            if typeof(data) ~= "string" or string.len(data) > 1000 then
                exploitSuspicion = exploitSuspicion + 2
            end
            -- Theo dõi dữ liệu tùy chỉnh (hack độc quyền/tùy chỉnh)
            table.insert(customDataCheck, tostring(data))
            if #customDataCheck > 10 and not string.match(table.concat(customDataCheck, ""), "^[a-zA-Z0-9%s%p]+$") then
                exploitSuspicion = exploitSuspicion + 3
            end
            if string.match(tostring(data), "[%[%]]") or string.match(tostring(data), "[^%w%s%p]") then
                exploitSuspicion = exploitSuspicion + 2
            end
            lastRemoteTime = currentTime
            if exploitSuspicion > 5 then
                banImmediately(player, "Phát hiện hack tùy chỉnh: Remote Event Manipulation")
            end
        end
    end)
    
    -- Kiểm tra chat (toxic, exploit, hack)
    player.Chatted:Connect(function(msg)
        msg = string.lower(msg)
        local isVietnamese = string.find(msg, "việt nam") or string.find(msg, "vn") or string.match(msg, "[áàạảãâấầậẩẫăắằặẳẵóòọỏõôốồộổỗơớờợởỡéèẹẻẽêếềệểễúùụủũưứừựửữíìịỉĩýỳỵỷỹđ]")
        local isForeign = string.match(msg, "[a-zA-Z]+") and not isVietnamese
        local specialChars = string.match(msg, "[^%w%s%p]")
        
        for _, word in pairs(ToxicWords) do
            if string.find(msg, word) then
                banImmediately(player, "Ngôn ngữ toxic hoặc phá map chat")
                return
            end
        end
        
        for _, word in pairs(RacistWords) do
            if string.find(msg, word) then
                banImmediately(player, "Ngôn ngữ phân biệt chủng tộc")
                return
            end
        end
        
        for _, sign in pairs(ExploitSigns) do
            if string.find(msg, sign) then
                exploitSuspicion = exploitSuspicion + 2
                if specialChars then
                    exploitSuspicion = exploitSuspicion + 1
                end
                if exploitSuspicion > 5 then
                    banImmediately(player, "Phát hiện hack tùy chỉnh: Ký hiệu hoặc từ liên quan đến cheat")
                    return
                end
            end
        end
        
        if isForeign and (string.find(msg, "vietnamese") or string.find(msg, "vn") or string.find(msg, "asia")) then
            banImmediately(player, "Ngôn ngữ phân biệt vùng miền")
            return
        end
    end)
    
    -- Kiểm tra phá map và exploit/hack gián tiếp
    spawn(obfuscate(function()
        while wait(checkInterval) do
            local currentTime = tick()
            local currentPosition = rootPart.Position
            local currentVelocity = rootPart.Velocity
            
            local distance = (currentPosition - lastPosition).Magnitude
            local timeDelta = currentTime - lastCheckTime
            local speed = distance / timeDelta
            if speed > 35 or speed < -35 then
                exploitSuspicion = exploitSuspicion + 1
                if (currentVelocity - lastVelocity).Magnitude > 100 then
                    exploitSuspicion = exploitSuspicion + 2
                end
                if exploitSuspicion > 5 then
                    banImmediately(player, "Speed Hack/Teleport - Phá map hoặc hack tùy chỉnh")
                end
                break
            end
            
            local ray = Ray.new(currentPosition, Vector3.new(0, -10, 0))
            local hit = workspace:FindPartOnRay(ray, character)
            if not hit or currentPosition.Y > lastPosition.Y + 15 or humanoid.JumpPower > 60 then
                exploitSuspicion = exploitSuspicion + 1
                if not hit and speed < 5 then
                    exploitSuspicion = exploitSuspicion + 2
                end
                if exploitSuspicion > 5 then
                    banImmediately(player, "Fly Hack - Phá map hoặc hack tùy chỉnh")
                end
                break
            end
            
            if currentPosition.Y < -10 or not workspace:FindPartOnRay(ray) then
                exploitSuspicion = exploitSuspicion + 1
                if speed < 5 then
                    exploitSuspicion = exploitSuspicion + 2
                end
                if exploitSuspicion > 5 then
                    banImmediately(player, "Noclip - Phá map hoặc hack tùy chỉnh")
                end
                break
            end
            
            for _, part in pairs(ProtectedParts) do
                if part:IsA("BasePart") and part.Anchored == false and (part.Position - currentPosition).Magnitude < 5 then
                    exploitSuspicion = exploitSuspicion + 1
                    if part.Transparency > 0.5 or part.Size.Magnitude > 10 or part.Parent ~= Workspace then
                        exploitSuspicion = exploitSuspicion + 2
                        table.insert(customObjectCheck, part)
                        if #customObjectCheck > 3 then
                            exploitSuspicion = exploitSuspicion + 3
                        end
                    end
                    if exploitSuspicion > 5 then
                        banImmediately(player, "Phá hủy hoặc di chuyển vật thể - Phá map hoặc hack tùy chỉnh")
                    end
                    break
                end
            end
            
            local clones = 0
            for _, plr in pairs(Players:GetPlayers()) do
                if plr ~= player and plr.Character and (plr.Character.HumanoidRootPart.Position - currentPosition).Magnitude < 5 then
                    clones = clones + 1
                end
            end
            if clones > 1 then
                exploitSuspicion = exploitSuspicion + 1
                if (currentVelocity - lastVelocity).Magnitude > 50 then
                    exploitSuspicion = exploitSuspicion + 2
                end
                if exploitSuspicion > 5 then
                    banImmediately(player, "Clone Hack - Phá map hoặc hack tùy chỉnh")
                end
                break
            end
            
            lastPosition = currentPosition
            lastCheckTime = currentTime
            lastVelocity = currentVelocity
        end
    end))
end

-- Khởi động kiểm tra khi người chơi join
Players.PlayerAdded:Connect(function(player)
    local success, err = pcall(function()
        advancedCheck(player)
    end)
    if not success then
        warn("Lỗi khi kiểm tra " .. player.Name .. ": " .. err)
    end
end)

-- Lưu ban khi server đóng
game:BindToClose(function()
    for _, player in pairs(Players:GetPlayers()) do
        if BanStore:GetAsync(player.UserId) then
            BanStore:SetAsync(player.UserId, true)
        end
    end
end)
